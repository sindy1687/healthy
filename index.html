<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å¤šé …å¥åº·ç´€éŒ„ç³»çµ± Prototype</title>
  <style>
    * { box-sizing: border-box; }
    body { 
      font-family: 'Segoe UI', 'Microsoft JhengHei', Arial, sans-serif; 
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      margin: 0; 
      padding: 20px; 
      min-height: 100vh;
    }
    .container { 
      max-width: 1200px; 
      margin: 0 auto; 
      background: rgba(255, 255, 255, 0.95); 
      border-radius: 20px; 
      box-shadow: 0 20px 40px rgba(0,0,0,0.1); 
      padding: 40px; 
      backdrop-filter: blur(10px);
    }
    h1 { 
      text-align: center; 
      color: #2d3748; 
      font-size: 2.5em;
      margin-bottom: 30px;
      font-weight: 300;
      text-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .form-section {
      background: linear-gradient(135deg, #f7fafc 0%, #edf2f7 100%);
      border-radius: 15px;
      padding: 30px;
      margin-bottom: 30px;
      box-shadow: 0 10px 25px rgba(0,0,0,0.05);
    }
    .form-title {
      font-size: 1.3em;
      color: #4a5568;
      margin-bottom: 20px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .form-title::before {
      content: "ğŸ“";
      font-size: 1.2em;
    }
    form { 
      display: grid; 
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px; 
      align-items: end;
    }
    .form-group { 
      display: flex; 
      flex-direction: column; 
    }
    .form-group.full-width {
      grid-column: 1 / -1;
    }
    label { 
      font-weight: 600; 
      margin-bottom: 8px; 
      color: #2d3748;
      font-size: 0.9em;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    input, select, textarea { 
      padding: 12px 16px; 
      border: 2px solid #e2e8f0; 
      border-radius: 10px; 
      font-size: 1em; 
      transition: all 0.3s ease;
      background: white;
    }
    input:focus, select:focus, textarea:focus { 
      outline: none; 
      border-color: #667eea; 
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
      transform: translateY(-2px);
    }
    button { 
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
      color: white; 
      border: none; 
      border-radius: 10px; 
      padding: 15px 30px; 
      font-size: 1em; 
      cursor: pointer; 
      transition: all 0.3s ease;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 1px;
    }
    button:hover { 
      transform: translateY(-2px); 
      box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
    }
    button:active { 
      transform: translateY(0); 
    }
    #printBtn { 
      background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
      margin-left: 0;
      margin-bottom: 0;
      white-space: nowrap;
    }
    #printBtn:hover {
      box-shadow: 0 10px 20px rgba(72, 187, 120, 0.3);
    }
    .export-buttons {
      float: right;
      margin-bottom: 20px;
      display: flex;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap;
      justify-content: flex-end;
    }
    .export-btn {
      background: linear-gradient(135deg, #ed8936 0%, #dd6b20 100%);
      padding: 12px 20px;
      font-size: 0.9em;
      white-space: nowrap;
    }
    .export-btn:hover {
      box-shadow: 0 10px 20px rgba(237, 137, 54, 0.3);
    }
    .export-btn.json {
      background: linear-gradient(135deg, #805ad5 0%, #6b46c1 100%);
    }
    .export-btn.json:hover {
      box-shadow: 0 10px 20px rgba(128, 90, 213, 0.3);
    }
    .import-btn {
      background: linear-gradient(135deg, #4299e1 0%, #3182ce 100%);
      padding: 12px 20px;
      font-size: 0.9em;
      color: #fff;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.3s ease;
      white-space: nowrap;
    }
    .import-btn:hover {
      box-shadow: 0 10px 20px rgba(66, 153, 225, 0.3);
    }
    .import-input {
      display: none;
    }
    .status { 
      font-size: 1.1em; 
      margin: 20px 0; 
      font-weight: 600; 
      padding: 15px;
      border-radius: 10px;
      text-align: center;
    }
    .table-section {
      background: white;
      border-radius: 15px;
      padding: 30px;
      box-shadow: 0 10px 25px rgba(0,0,0,0.05);
    }
    .table-title {
      font-size: 1.3em;
      color: #4a5568;
      margin-bottom: 20px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .table-title::before {
      content: "ğŸ“Š";
      font-size: 1.2em;
    }
    table { 
      width: 100%; 
      border-collapse: collapse; 
      background: white;
      border-radius: 10px;
      overflow: hidden;
      box-shadow: 0 5px 15px rgba(0,0,0,0.08);
    }
    th, td { 
      padding: 15px 12px; 
      text-align: center; 
      border-bottom: 1px solid #e2e8f0;
    }
    th { 
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
      color: white;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      font-size: 0.9em;
    }
    tr:hover {
      background: #f7fafc;
    }
    .level-normal { 
      color: #38a169; 
      font-weight: 600;
    }
    .level-pre { 
      color: #d69e2e; 
      font-weight: 600;
    }
    .level-1 { 
      color: #e53e3e; 
      font-weight: 600;
    }
    .level-2 { 
      color: #c53030; 
      font-weight: 600;
    }
    .empty-message {
      text-align: center;
      color: #718096;
      font-style: italic;
      padding: 40px;
    }
    .delete-btn {
      background: linear-gradient(135deg, #e53e3e 0%, #c53030 100%);
      color: white;
      border: none;
      border-radius: 6px;
      padding: 6px 12px;
      font-size: 0.8em;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    .delete-btn:hover {
      box-shadow: 0 4px 8px rgba(229, 62, 62, 0.3);
      transform: translateY(-1px);
    }
    .clear-all-btn {
      background: linear-gradient(135deg, #e53e3e 0%, #c53030 100%);
      color: white;
      border: none;
      border-radius: 10px;
      padding: 12px 20px;
      font-size: 0.9em;
      cursor: pointer;
      transition: all 0.3s ease;
      margin-left: 0;
      white-space: nowrap;
    }
    .clear-all-btn:hover {
      box-shadow: 0 8px 16px rgba(229, 62, 62, 0.3);
    }
    .print-controls {
      display: flex;
      align-items: center;
      gap: 15px;
      margin: 50px 0 20px 0;
      padding: 20px;
      background: linear-gradient(135deg, #f7fafc 0%, #edf2f7 100%);
      border-radius: 10px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }
    .print-controls label {
      font-weight: 600;
      color: #4a5568;
      margin: 0;
      text-transform: none;
      letter-spacing: normal;
    }
    .print-controls select,
    .print-controls input {
      padding: 8px 12px;
      border: 2px solid #e2e8f0;
      border-radius: 8px;
      font-size: 0.9em;
      background: white;
    }
    .print-controls select:focus,
    .print-controls input:focus {
      border-color: #667eea;
      box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.1);
    }
    .date-range {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .date-range input {
      width: 130px;
    }
    @media (max-width: 768px) {
      .container { padding: 20px; }
      form { grid-template-columns: 1fr; }
      h1 { font-size: 2em; }
      table { font-size: 0.9em; }
      th, td { padding: 10px 8px; }
      .export-buttons {
        float: none;
        justify-content: center;
        margin-bottom: 15px;
      }
      .export-buttons > * {
        margin: 5px;
      }
    }
    @media print {
      body { background: white; }
      .container { box-shadow: none; padding: 0; }
      .form-section, #printBtn { display: none !important; }
      h1 { margin-top: 0; }
      table { box-shadow: none; }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ¥ å¤šé …å¥åº·ç´€éŒ„ç³»çµ±</h1>
    
    <div class="form-section">
      <div class="form-title">â¤ï¸ è¡€å£“ç´€éŒ„</div>
      <form id="bpForm">
        <div class="form-group">
          <label for="bpDatetime">ğŸ“… æ—¥æœŸæ™‚é–“</label>
          <input type="datetime-local" id="bpDatetime" name="datetime" required>
        </div>
        <div class="form-group">
          <label for="bpTimePeriod">â° æ™‚æ®µ</label>
          <select id="bpTimePeriod" name="timePeriod" required>
            <option value="æ—©ä¸Š">ğŸŒ… æ—©ä¸Š</option>
            <option value="ä¸‹åˆ">ğŸŒ† ä¸‹åˆ</option>
          </select>
        </div>
        <div class="form-group">
          <label for="systolic">â¤ï¸ æ”¶ç¸®å£“ (mmHg)</label>
          <input type="number" id="systolic" name="systolic" min="50" max="250" placeholder="120" required>
        </div>
        <div class="form-group">
          <label for="diastolic">ğŸ’“ èˆ’å¼µå£“ (mmHg)</label>
          <input type="number" id="diastolic" name="diastolic" min="30" max="150" placeholder="80" required>
        </div>
        <div class="form-group">
          <label for="heartRate">ğŸ’— å¿ƒè·³ (bpm)</label>
          <input type="number" id="heartRate" name="heartRate" min="30" max="200" placeholder="75" required>
        </div>
        <div class="form-group full-width">
          <label for="bpNote">ğŸ“ å‚™è¨»</label>
          <textarea id="bpNote" name="note" rows="2" placeholder="ä¾‹å¦‚ï¼šé‹å‹•å¾Œæ¸¬é‡ã€å‰›èµ·åºŠã€ç”¨è—¥å¾Œ..."></textarea>
        </div>
        <div class="form-group full-width">
          <button type="submit">âœ… æ–°å¢è¡€å£“ç´€éŒ„</button>
        </div>
      </form>
    </div>

    <div class="form-section">
      <div class="form-title">ğŸ©¸ è¡€ç³–ç´€éŒ„</div>
      <form id="sugarForm">
        <div class="form-group">
          <label for="sugarDatetime">ğŸ“… æ—¥æœŸæ™‚é–“</label>
          <input type="datetime-local" id="sugarDatetime" name="datetime" required>
        </div>
        <div class="form-group">
          <label for="sugarTimePeriod">â° æ™‚æ®µ</label>
          <select id="sugarTimePeriod" name="timePeriod" required>
            <option value="æ—©ä¸Š">ğŸŒ… æ—©ä¸Š</option>
            <option value="ä¸‹åˆ">ğŸŒ† ä¸‹åˆ</option>
          </select>
        </div>
        <div class="form-group">
          <label for="bloodSugar">ğŸ©¸ è¡€ç³– (mg/dL)</label>
          <input type="number" id="bloodSugar" name="bloodSugar" min="40" max="400" placeholder="100" required>
        </div>
        <div class="form-group">
          <label for="sugarType">ğŸ½ï¸ è¡€ç³–æ™‚æ©Ÿ</label>
          <select id="sugarType" name="sugarType" required>
            <option value="é£¯å‰">ğŸ½ï¸ é£¯å‰</option>
            <option value="é£¯å¾Œ">ğŸ´ é£¯å¾Œ</option>
          </select>
        </div>
        <div class="form-group full-width">
          <label for="sugarNote">ğŸ“ å‚™è¨»</label>
          <textarea id="sugarNote" name="note" rows="2" placeholder="ä¾‹å¦‚ï¼šé‹å‹•å¾Œæ¸¬é‡ã€å‰›èµ·åºŠã€ç”¨è—¥å¾Œ..."></textarea>
        </div>
        <div class="form-group full-width">
          <button type="submit">âœ… æ–°å¢è¡€ç³–ç´€éŒ„</button>
        </div>
      </form>
    </div>

    <div class="status" id="statusMsg"></div>
    
    <div class="table-section">
      <div class="table-title">å¥åº·ç´€éŒ„ç¸½è¦½</div>
      <div class="export-buttons">
        <button class="export-btn" onclick="exportToCSV()">ğŸ“Š åŒ¯å‡º CSV</button>
        <button class="export-btn json" onclick="exportToJSON()">ğŸ’¾ åŒ¯å‡º JSON</button>
        <label class="import-btn" for="importInput">â¬†ï¸ åŒ¯å…¥ JSON
          <input id="importInput" class="import-input" type="file" accept="application/json" onchange="importFromJSON(event)">
        </label>
        <button id="printBtn" onclick="printSelectedRecords()">ğŸ–¨ï¸ åˆ—å°ç´€éŒ„è¡¨</button>
        <button class="clear-all-btn" onclick="clearAllRecords()">ğŸ—‘ï¸ æ¸…ç©ºæ‰€æœ‰ç´€éŒ„</button>
      </div>
      
      <div class="print-controls">
        <label>ğŸ“… åˆ—å°ç¯„åœï¼š</label>
        <select id="printRange" onchange="updateDateInputs()">
          <option value="today">ä»Šå¤©</option>
          <option value="7days">æœ€è¿‘7å¤©</option>
          <option value="30days">æœ€è¿‘30å¤©</option>
          <option value="custom">è‡ªè¨‚æ—¥æœŸç¯„åœ</option>
        </select>
        <div class="date-range" id="customDateRange" style="display:none;">
          <label>å¾ï¼š</label>
          <input type="date" id="startDate">
          <label>åˆ°ï¼š</label>
          <input type="date" id="endDate">
        </div>
      </div>
      <table id="recordTable">
        <thead>
          <tr>
            <th>ğŸ“… æ—¥æœŸ</th>
            <th>â° æ™‚æ®µ</th>
            <th>ğŸ“Š é¡å‹</th>
            <th>â¤ï¸ æ”¶ç¸®å£“</th>
            <th>ğŸ’“ èˆ’å¼µå£“</th>
            <th>ğŸ’— å¿ƒè·³</th>
            <th>ğŸ©¸ è¡€ç³–</th>
            <th>ğŸ½ï¸ è¡€ç³–æ™‚æ©Ÿ</th>
            <th>ğŸ“Š åˆ†ç´š</th>
            <th>ğŸ“ å‚™è¨»</th>
            <th>âŒ æ“ä½œ</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td colspan="11" class="empty-message">å°šç„¡ç´€éŒ„ï¼Œè«‹æ–°å¢æ‚¨çš„ç¬¬ä¸€ç­†å¥åº·è³‡æ–™</td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <script>
    // åˆ†ç´šåˆ¤æ–·é‚è¼¯
    function getBpLevel(s, d) {
      if (s === '' || d === '' || isNaN(s) || isNaN(d)) return null;
      if (s >= 160 || d >= 100) return { level: 'ğŸš¨ äºŒæœŸé«˜è¡€å£“', class: 'level-2' };
      if (s >= 140 || d >= 90) return { level: 'âš ï¸ ä¸€æœŸé«˜è¡€å£“', class: 'level-1' };
      if (s >= 120 || d >= 80) return { level: 'ğŸŒŸ é«˜è¡€å£“å‰æœŸ', class: 'level-pre' };
      return { level: 'ğŸ’š æ­£å¸¸', class: 'level-normal' };
    }
    function getSugarLevel(val, type) {
      if (!val || isNaN(val) || type !== 'é£¯å‰') return null;
      if (val >= 126) return { level: 'âš ï¸ è¡€ç³–éé«˜', class: 'level-1' };
      if (val >= 100) return { level: 'ğŸŒŸ è¡€ç³–åé«˜', class: 'level-pre' };
      if (val >= 70) return { level: 'ğŸ’š è¡€ç³–æ­£å¸¸', class: 'level-normal' };
      return { level: 'âš ï¸ è¡€ç³–éä½', class: 'level-2' };
    }

    // å–å¾— localStorage ç´€éŒ„
    function getRecords() {
      return JSON.parse(localStorage.getItem('bpRecords') || '[]');
    }
    // å„²å­˜åˆ° localStorage
    function saveRecords(records) {
      localStorage.setItem('bpRecords', JSON.stringify(records));
    }
    // é¡¯ç¤ºè¡¨æ ¼
    function renderTable() {
      const records = getRecords();
      const tbody = document.querySelector('#recordTable tbody');
      tbody.innerHTML = '';
      
      if (records.length === 0) {
        tbody.innerHTML = '<tr><td colspan="11" class="empty-message">å°šç„¡ç´€éŒ„ï¼Œè«‹æ–°å¢æ‚¨çš„ç¬¬ä¸€ç­†å¥åº·è³‡æ–™</td></tr>';
        return;
      }
      
      records.sort((a, b) => new Date(b.datetime) - new Date(a.datetime));
      for (const rec of records) {
        const d = new Date(rec.datetime);
        const dateStr = d.toLocaleDateString('zh-Hant', { year: 'numeric', month: '2-digit', day: '2-digit' });
        let levelStr = '';
        if (rec.bpLevel) levelStr += `<span class="${rec.bpLevel.class}">${rec.bpLevel.level}</span> `;
        if (rec.sugarLevel) levelStr += `<span class="${rec.sugarLevel.class}">${rec.sugarLevel.level}</span>`;
        tbody.innerHTML += `<tr>
          <td>${dateStr}</td>
          <td>${rec.timePeriod || ''}</td>
          <td>${rec.type === 'bloodPressure' ? 'â¤ï¸ è¡€å£“' : 'ğŸ©¸ è¡€ç³–'}</td>
          <td>${rec.systolic ?? ''}</td>
          <td>${rec.diastolic ?? ''}</td>
          <td>${rec.heartRate ?? ''}</td>
          <td>${rec.bloodSugar ?? ''}</td>
          <td>${rec.sugarType ?? ''}</td>
          <td>${levelStr}</td>
          <td>${rec.note ? rec.note : ''}</td>
          <td><button class="delete-btn" onclick="deleteRecord(${records.indexOf(rec)})">ğŸ—‘ï¸ åˆªé™¤</button></td>
        </tr>`;
      }
    }
    // è¡€å£“è¡¨å–®é€å‡º
    document.getElementById('bpForm').onsubmit = function(e) {
      e.preventDefault();
      const datetime = document.getElementById('bpDatetime').value;
      const timePeriod = document.getElementById('bpTimePeriod').value;
      const systolic = document.getElementById('systolic').value;
      const diastolic = document.getElementById('diastolic').value;
      const heartRate = document.getElementById('heartRate').value;
      const note = document.getElementById('bpNote').value.trim();
      
      if (!datetime) return;
      
      const bpLevel = getBpLevel(Number(systolic), Number(diastolic));
      
      // ç‹€æ…‹é¡¯ç¤º
      document.getElementById('statusMsg').innerHTML = `<span class="${bpLevel.class}">${bpLevel.level}</span>`;
      
      // æ–°å¢ç´€éŒ„
      const records = getRecords();
      records.push({
        datetime, 
        timePeriod,
        type: 'bloodPressure',
        systolic: Number(systolic),
        diastolic: Number(diastolic),
        heartRate: Number(heartRate),
        note,
        bpLevel
      });
      
      saveRecords(records);
      renderTable();
      this.reset();
      document.getElementById('bpDatetime').value = new Date().toISOString().slice(0,16);
    };
    
    // è¡€ç³–è¡¨å–®é€å‡º
    document.getElementById('sugarForm').onsubmit = function(e) {
      e.preventDefault();
      const datetime = document.getElementById('sugarDatetime').value;
      const timePeriod = document.getElementById('sugarTimePeriod').value;
      const bloodSugar = document.getElementById('bloodSugar').value;
      const sugarType = document.getElementById('sugarType').value;
      const note = document.getElementById('sugarNote').value.trim();
      
      if (!datetime) return;
      
      const sugarLevel = getSugarLevel(Number(bloodSugar), sugarType);
      
      // ç‹€æ…‹é¡¯ç¤º
      if (sugarLevel) {
        document.getElementById('statusMsg').innerHTML = `<span class="${sugarLevel.class}">${sugarLevel.level}</span>`;
      } else {
        document.getElementById('statusMsg').innerHTML = '<span style="color:#718096">è¡€ç³–ç´€éŒ„å·²æ–°å¢</span>';
      }
      
      // æ–°å¢ç´€éŒ„
      const records = getRecords();
      records.push({
        datetime, 
        timePeriod,
        type: 'bloodSugar',
        bloodSugar: Number(bloodSugar),
        sugarType,
        note,
        sugarLevel
      });
      
      saveRecords(records);
      renderTable();
      this.reset();
      document.getElementById('sugarDatetime').value = new Date().toISOString().slice(0,16);
    };

    // é é¢è¼‰å…¥æ™‚
    window.onload = function() {
      // é è¨­å¡«å…¥ç¾åœ¨æ™‚é–“
      document.getElementById('bpDatetime').value = new Date().toISOString().slice(0,16);
      document.getElementById('sugarDatetime').value = new Date().toISOString().slice(0,16);
      renderTable();
    };

    // åŒ¯å‡º CSV åŠŸèƒ½
    function exportToCSV() {
      const records = getRecords();
      if (records.length === 0) {
        alert('å°šç„¡ç´€éŒ„å¯åŒ¯å‡º');
        return;
      }
      
      let csv = 'æ—¥æœŸ,æ™‚æ®µ,é¡å‹,æ”¶ç¸®å£“,èˆ’å¼µå£“,å¿ƒè·³,è¡€ç³–,è¡€ç³–æ™‚æ©Ÿ,åˆ†ç´š,å‚™è¨»\n';
      
      records.sort((a, b) => new Date(b.datetime) - new Date(a.datetime));
      for (const rec of records) {
        const d = new Date(rec.datetime);
        const dateStr = d.toLocaleDateString('zh-Hant', { year: 'numeric', month: '2-digit', day: '2-digit' });
        let levelStr = '';
        if (rec.bpLevel) levelStr += rec.bpLevel.level + ' ';
        if (rec.sugarLevel) levelStr += rec.sugarLevel.level;
        
        csv += `"${dateStr}","${rec.timePeriod || ''}","${rec.type === 'bloodPressure' ? 'â¤ï¸ è¡€å£“' : 'ğŸ©¸ è¡€ç³–'}","${rec.systolic || ''}","${rec.diastolic || ''}","${rec.heartRate || ''}","${rec.bloodSugar || ''}","${rec.sugarType || ''}","${levelStr}","${rec.note || ''}"\n`;
      }
      
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      const url = URL.createObjectURL(blob);
      link.setAttribute('href', url);
      link.setAttribute('download', `å¥åº·ç´€éŒ„_${new Date().toISOString().slice(0,10)}.csv`);
      link.style.visibility = 'hidden';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }
    
    // åŒ¯å‡º JSON åŠŸèƒ½
    function exportToJSON() {
      const records = getRecords();
      if (records.length === 0) {
        alert('å°šç„¡ç´€éŒ„å¯åŒ¯å‡º');
        return;
      }
      
      const dataStr = JSON.stringify(records, null, 2);
      const blob = new Blob([dataStr], { type: 'application/json;charset=utf-8;' });
      const link = document.createElement('a');
      const url = URL.createObjectURL(blob);
      link.setAttribute('href', url);
      link.setAttribute('download', `å¥åº·ç´€éŒ„_${new Date().toISOString().slice(0,10)}.json`);
      link.style.visibility = 'hidden';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }

    // åŒ¯å…¥ JSON åŠŸèƒ½
    function importFromJSON(event) {
      const file = event.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          const imported = JSON.parse(e.target.result);
          if (!Array.isArray(imported)) throw new Error('æ ¼å¼éŒ¯èª¤');
          const records = getRecords();
          // åˆä½µè³‡æ–™ï¼ˆé¿å…é‡è¤‡: ä»¥ datetime+æ™‚æ®µ åˆ¤æ–·ï¼‰
          const key = r => `${r.datetime}_${r.timePeriod}`;
          const existMap = Object.fromEntries(records.map(r => [key(r), r]));
          for (const rec of imported) {
            if (!existMap[key(rec)]) records.push(rec);
          }
          saveRecords(records);
          renderTable();
          document.getElementById('statusMsg').innerHTML = '<span style="color:#3182ce">âœ… åŒ¯å…¥æˆåŠŸï¼</span>';
        } catch {
          alert('åŒ¯å…¥å¤±æ•—ï¼Œè«‹ç¢ºèªæª”æ¡ˆæ ¼å¼æ­£ç¢ºï¼');
        }
        event.target.value = '';
      };
      reader.readAsText(file);
    }

    // åˆªé™¤å–®ç­†ç´€éŒ„
    function deleteRecord(index) {
      if (confirm('ç¢ºå®šè¦åˆªé™¤é€™ç­†ç´€éŒ„å—ï¼Ÿ')) {
        const records = getRecords();
        records.splice(index, 1);
        saveRecords(records);
        renderTable();
        document.getElementById('statusMsg').innerHTML = '<span style="color:#e53e3e">ğŸ—‘ï¸ ç´€éŒ„å·²åˆªé™¤</span>';
      }
    }
    
    // æ¸…ç©ºæ‰€æœ‰ç´€éŒ„
    function clearAllRecords() {
      if (confirm('ç¢ºå®šè¦æ¸…ç©ºæ‰€æœ‰ç´€éŒ„å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸï¼')) {
        localStorage.removeItem('bpRecords');
        renderTable();
        document.getElementById('statusMsg').innerHTML = '<span style="color:#e53e3e">ğŸ—‘ï¸ æ‰€æœ‰ç´€éŒ„å·²æ¸…ç©º</span>';
      }
    }

    // æ›´æ–°æ—¥æœŸè¼¸å…¥æ¬„ä½é¡¯ç¤º
    function updateDateInputs() {
      const range = document.getElementById('printRange').value;
      const customRange = document.getElementById('customDateRange');
      const startDate = document.getElementById('startDate');
      const endDate = document.getElementById('endDate');
      
      if (range === 'custom') {
        customRange.style.display = 'flex';
        const today = new Date().toISOString().slice(0,10);
        startDate.value = today;
        endDate.value = today;
      } else {
        customRange.style.display = 'none';
      }
    }
    
    // å–å¾—é¸å®šç¯„åœçš„ç´€éŒ„
    function getFilteredRecords() {
      const records = getRecords();
      const range = document.getElementById('printRange').value;
      const today = new Date();
      today.setHours(0, 0, 0, 0);
      
      let filtered = records;
      
      switch(range) {
        case 'today':
          filtered = records.filter(rec => {
            const recDate = new Date(rec.datetime);
            recDate.setHours(0, 0, 0, 0);
            return recDate.getTime() === today.getTime();
          });
          break;
        case '7days':
          const weekAgo = new Date(today);
          weekAgo.setDate(today.getDate() - 7);
          filtered = records.filter(rec => {
            const recDate = new Date(rec.datetime);
            return recDate >= weekAgo;
          });
          break;
        case '30days':
          const monthAgo = new Date(today);
          monthAgo.setDate(today.getDate() - 30);
          filtered = records.filter(rec => {
            const recDate = new Date(rec.datetime);
            return recDate >= monthAgo;
          });
          break;
        case 'custom':
          const startDate = new Date(document.getElementById('startDate').value);
          const endDate = new Date(document.getElementById('endDate').value);
          endDate.setHours(23, 59, 59, 999);
          filtered = records.filter(rec => {
            const recDate = new Date(rec.datetime);
            return recDate >= startDate && recDate <= endDate;
          });
          break;
      }
      
      return filtered.sort((a, b) => new Date(b.datetime) - new Date(a.datetime));
    }
    
    // åˆ—å°é¸å®šç¯„åœçš„ç´€éŒ„
    function printSelectedRecords() {
      const filteredRecords = getFilteredRecords();
      if (filteredRecords.length === 0) {
        alert('é¸å®šç¯„åœå…§æ²’æœ‰ç´€éŒ„å¯åˆ—å°');
        return;
      }
      
      // å»ºç«‹åˆ—å°è¦–çª—
      const printWindow = window.open('', '_blank');
      const range = document.getElementById('printRange').value;
      let rangeText = '';
      
      switch(range) {
        case 'today':
          rangeText = 'ä»Šå¤©';
          break;
        case '7days':
          rangeText = 'æœ€è¿‘7å¤©';
          break;
        case '30days':
          rangeText = 'æœ€è¿‘30å¤©';
          break;
        case 'custom':
          const startDate = document.getElementById('startDate').value;
          const endDate = document.getElementById('endDate').value;
          rangeText = `${startDate} è‡³ ${endDate}`;
          break;
      }
      
      printWindow.document.write(`
        <!DOCTYPE html>
        <html>
        <head>
          <title>å¥åº·ç´€éŒ„è¡¨ - ${rangeText}</title>
          <style>
            body { font-family: 'Microsoft JhengHei', Arial, sans-serif; margin: 20px; }
            h1 { text-align: center; color: #2d3748; }
            table { width: 100%; border-collapse: collapse; margin-top: 20px; }
            th, td { border: 1px solid #ddd; padding: 8px; text-align: center; }
            th { background: #f7fafc; font-weight: bold; }
            .level-normal { color: #38a169; }
            .level-pre { color: #d69e2e; }
            .level-1 { color: #e53e3e; }
            .level-2 { color: #c53030; }
            @media print { body { margin: 0; } }
          </style>
        </head>
        <body>
          <h1>ğŸ¥ å¥åº·ç´€éŒ„è¡¨</h1>
          <p><strong>åˆ—å°ç¯„åœï¼š</strong>${rangeText}</p>
          <p><strong>åˆ—å°æ™‚é–“ï¼š</strong>${new Date().toLocaleString('zh-Hant')}</p>
          <table>
            <thead>
              <tr>
                <th>æ—¥æœŸ</th>
                <th>æ™‚æ®µ</th>
                <th>é¡å‹</th>
                <th>æ”¶ç¸®å£“</th>
                <th>èˆ’å¼µå£“</th>
                <th>å¿ƒè·³</th>
                <th>è¡€ç³–</th>
                <th>è¡€ç³–æ™‚æ©Ÿ</th>
                <th>åˆ†ç´š</th>
                <th>å‚™è¨»</th>
              </tr>
            </thead>
            <tbody>
              ${filteredRecords.map(rec => {
                const d = new Date(rec.datetime);
                const dateStr = d.toLocaleDateString('zh-Hant', { year: 'numeric', month: '2-digit', day: '2-digit' });
                let levelStr = '';
                if (rec.bpLevel) levelStr += `<span class="${rec.bpLevel.class}">${rec.bpLevel.level}</span> `;
                if (rec.sugarLevel) levelStr += `<span class="${rec.sugarLevel.class}">${rec.sugarLevel.level}</span>`;
                return `<tr>
                  <td>${dateStr}</td>
                  <td>${rec.timePeriod || ''}</td>
                  <td>${rec.type === 'bloodPressure' ? 'â¤ï¸ è¡€å£“' : 'ğŸ©¸ è¡€ç³–'}</td>
                  <td>${rec.systolic ?? ''}</td>
                  <td>${rec.diastolic ?? ''}</td>
                  <td>${rec.heartRate ?? ''}</td>
                  <td>${rec.bloodSugar ?? ''}</td>
                  <td>${rec.sugarType ?? ''}</td>
                  <td>${levelStr}</td>
                  <td>${rec.note ? rec.note : ''}</td>
                </tr>`;
              }).join('')}
            </tbody>
          </table>
        </body>
        </html>
      `);
      
      printWindow.document.close();
      printWindow.focus();
      setTimeout(() => printWindow.print(), 500);
    }
  </script>
</body>
</html> 